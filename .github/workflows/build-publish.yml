name: build-publish
on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      dockerfile:
        required: true
        type: string
      repository-name:
        required: true
        type: string
      image-name:
        required: true
        type: string
    outputs:
      tagged-image-url:
        value: ${{ jobs.build-publish.outputs.tagged-image-url }}
jobs:
  build-publish:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    outputs:
      tagged-image-url: ${{ steps.output.outputs.tagged_image_url }}
    env:
      IMAGE_URL: ${{ vars.CLOUD_REGISTRY_URL }}/${{ vars.GCP_PROJECT_ID }}/${{ inputs.repository-name }}/${{ inputs.image-name }}
    steps:
      - name: 'Checkout Repo'
        uses: actions/checkout@v4
      - name: 'GCloud Authentication'
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: ${{ secrets.CLOUD_REGISTRY_SERVICE_ACCOUNT_CREDS }}
      - name: 'Setup GCloud CLI'
        uses: 'google-github-actions/setup-gcloud@v2'
        with:
          version: '>= 363.0.0'
      - name: 'Generate Image Tag'
        id: generate-image-tag
        run: |
          echo "image_tag=${{ github.sha::0:8 }}" >> $GITHUB_OUTPUT
      - name: 'Build Image'
        run: |
          docker build \
          -t ${{ env.IMAGE_URL }}:latest \
          -t ${{ env.IMAGE_URL }}:${{ steps.generate-image-tag.outputs.image_tag }} \
          -f ${{ inputs.dockerfile }} \
          .
        shell: bash
      - name: 'Push Image to Cloud Artifact Registry'
        run: |
          gcloud auth configure-docker ${{ vars.CLOUD_REGISTRY_URL }}
          docker push ${{ env.IMAGE_URL }} --all-tags
        shell: bash
      - name: 'Output Tagged Image URL'
        id: output
        run: |
          echo "tagged_image_url=${{ env.IMAGE_URL }}:${{ steps.generate-image-tag.outputs.image_tag }}" >> $GITHUB_OUTPUT
        shell: bash
